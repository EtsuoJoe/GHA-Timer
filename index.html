<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro HIIT</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --crt-green: #39ff14; 
            --crt-amber: #ffb000;
        }

        body {
            background-color: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'VT323', monospace;
            color: var(--crt-green);
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 800px; 
        }

        #bg-image {
            width: 100%;
            height: auto;
            display: block;
        }

        /* --- THE TIMER OVERLAY --- */
        #crt-screen {
            position: absolute;
            top: 46%;
            left: 14%;
            width: 70%;
            height: 40%;
            background-color: transparent; 
            padding: 0 5%; 
            box-sizing: border-box; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-shadow: 0 0 4px var(--crt-green);
        }

        /* SETUP SCREEN STYLES */
        #setup-area {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-bottom: 8%; 
        }

        .setup-controls {
            display: flex;
            justify-content: space-between; 
            align-items: flex-end; 
            width: 100%;
            margin-bottom: 2%; 
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .input-group label {
            font-size: 3vw;
            margin-bottom: 2px;
        }

        input[type="number"] {
            background: rgba(0, 0, 0, 0.6); 
            border: 1px solid var(--crt-green);
            color: var(--crt-green);
            font-family: 'VT323', monospace;
            font-size: 3vw; 
            width: 9vw;
            text-align: center;
        }

        /* TABATA PRESET BUTTON */
        #tabata-btn {
            background: transparent;
            color: var(--crt-amber);
            border: 1px solid var(--crt-amber);
            font-family: 'VT323', monospace;
            font-size: 2vw; 
            padding: 2px 8px;
            cursor: pointer;
            text-transform: uppercase;
            margin-bottom: 4%;
            text-shadow: 0 0 2px var(--crt-amber);
            box-shadow: 0 0 2px var(--crt-amber);
        }
        #tabata-btn:hover {
            background: var(--crt-amber);
            color: black;
        }

        /* ACTION ROW */
        .action-row {
            display: flex;
            align-items: center; 
            justify-content: center;
            gap: 5vw; 
            width: 100%;
        }

        .checkbox-group {
             display: flex;
             flex-direction: column;
             align-items: center;
             cursor: pointer;
        }

        .checkbox-group label {
            font-size: 2vw; 
            margin-bottom: 2px;
            text-align: center;
            line-height: 1;
        }
        
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 2vw;   
            height: 2vw;  
            background-color: rgba(0,0,0,0.6);
            border: 1px solid var(--crt-green);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: 5px;
        }
        
        input[type="checkbox"]:checked {
            background-color: var(--crt-green);
            box-shadow: inset 0 0 3px #000;
        }

        /* START BUTTON */
        #start-btn {
            background: var(--crt-green);
            color: black;
            border: none;
            font-family: 'VT323', monospace;
            font-size: 3.5vw;
            padding: 0.5% 3%;
            cursor: pointer;
            text-transform: uppercase;
        }
        #start-btn:hover { background: white; }

        /* --- SFX BUTTON --- */
        #sfx-btn {
            position: absolute;
            /* MOVED UP SIGNIFICANTLY to 12% */
            bottom: 9%; 
            left: 50%;
            transform: translateX(-50%);
            
            background: #222; 
            color: #888;
            border: 2px solid #444;
            border-bottom: 4px solid #111; 
            border-radius: 4px;
            
            font-family: sans-serif;
            font-weight: bold;
            font-size: 1.5vw;
            padding: 0.5% 2%;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 20;
        }
        
        #sfx-btn:active {
            border-bottom: 2px solid #111;
            transform: translateX(-50%) translateY(2px);
        }

        #sfx-led {
            width: 1vw;
            height: 1vw;
            border-radius: 50%;
            background-color: #39ff14; 
            box-shadow: 0 0 5px #39ff14;
        }
        
        .sfx-muted #sfx-led {
            background-color: #ff0000; 
            box-shadow: 0 0 5px #ff0000;
        }

        /* WORKOUT SCREEN STYLES */
        #workout-area {
            position: relative; 
            height: 100%; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center;
        }

        #reset-btn {
            position: absolute;
            top: 5%; 
            right: 0%; 
            background: transparent;
            color: var(--crt-green);
            border: 1px solid var(--crt-green);
            font-family: 'VT323', monospace;
            font-size: 2vw; 
            padding: 2px 5px;
            cursor: pointer;
            text-transform: uppercase;
            z-index: 10;
        }
        #reset-btn:hover { background: var(--crt-green); color: black; }

        #rounds-tracker { font-size: 3vw; text-align: center; margin-top: 4%; }

        #main-display {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
            align-items: center;
            line-height: 1; 
        }

        #status-label { font-size: 5vw; text-align: center; text-transform: uppercase; }
        #time-remaining { font-size: 11vw; line-height: 0.9; text-align: center; margin-bottom: 2%; }
        
        .hidden { display: none !important; }

        @keyframes fast-blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
        .blinking { animation: fast-blink 0.5s infinite; color: orange !important; }


        /* --- DESKTOP / ULTRAWIDE FIX --- */
        @media (min-width: 800px) {
            .input-group label { font-size: 32px; } 
            input[type="number"] { font-size: 40px; width: 110px; } 
            
            .checkbox-group label { font-size: 20px; } 
            input[type="checkbox"] { width: 25px; height: 25px; } 
            
            #start-btn { font-size: 36px; padding: 5px 20px; } 
            
            #tabata-btn { font-size: 20px; margin-bottom: 20px;}
            
            #status-label { font-size: 50px; } 
            #time-remaining { font-size: 110px; } 
            #rounds-tracker { font-size: 30px; } 
            #reset-btn { font-size: 20px; } 
            
            #sfx-btn { font-size: 14px; bottom: 80px; } 
            #sfx-led { width: 10px; height: 10px; }
        }

        /* --- MOBILE SCREEN DETECTOR --- */
        @media (max-width: 768px) {
            .input-group label { font-size: 5vw; }
            input[type="number"] { font-size: 5vw; width: 14vw; }
            .checkbox-group label { font-size: 3.5vw; }
            input[type="checkbox"] { width: 5vw; height: 5vw; }
            #start-btn { font-size: 5vw; padding: 1% 4%; }
            #status-label { font-size: 8vw; }
            #time-remaining { font-size: 20vw; }
            #rounds-tracker { font-size: 5vw; }
            #reset-btn { font-size: 4vw; top: 2%; right: -2%; }
            #setup-area { padding-bottom: 2%; }
            
            #tabata-btn { font-size: 4vw; }
            #sfx-btn { font-size: 3vw; bottom: 12%; width: max-content;}
            #sfx-led { width: 3vw; height: 3vw; }
        }

    </style>
</head>
<body>

    <div id="game-container">
        <img src="bg.png" id="bg-image" alt="Retro TV Background">

        <div id="sfx-btn">
            <div id="sfx-led"></div> SFX
        </div>

        <div id="crt-screen">
            
            <div id="setup-area">
                <div class="setup-controls">
                    <div class="input-group">
                        <label>WORK</label>
                        <input type="number" id="work-in" value="30">
                    </div>
                    <div class="input-group">
                        <label>REST</label>
                        <input type="number" id="rest-in" value="10">
                    </div>
                    <div class="input-group">
                        <label>RNDS</label>
                        <input type="number" id="rounds-in" value="8">
                    </div>
                </div>

                <button id="tabata-btn">LOAD TABATA PRESET</button>

                <div class="action-row">
                    <div class="checkbox-group">
                        <label>INITIAL<br>DELAY</label>
                        <input type="checkbox" id="delay-in" checked>
                    </div>
                    <button id="start-btn">INITIALIZE</button>
                </div>
            </div>

            <div id="workout-area" class="hidden">
                 <button id="reset-btn">RESET</button>

                 <div id="rounds-tracker">RND: <span id="curr-round">1</span>/<span id="total-rounds-disp">8</span></div>
                 
                 <div id="main-display">
                    <div id="status-label">READY</div>
                    <div id="time-remaining">00</div>
                 </div>
            </div>

        </div>
    </div>

    <script>
        let workSecs, restSecs, totalRounds;
        let currentRound = 1;
        let isWorking = true;
        let isDelaying = false;
        let timeLeft;
        let timerInterval;
        let isMuted = false;

        // --- RELIABLE AUDIO ENGINE ---
        // 1. Create global audio objects immediately
        const audioLib = {
            beep: new Audio('beep.mp3'),
            work: new Audio('work.mp3'),
            rest: new Audio('rest.mp3'),
            final: new Audio('final.mp3'),
            victory: new Audio('victory.mp3')
        };

        // 2. The Play Function
        function playSfx(key) {
            if (isMuted) return;
            
            const sound = audioLib[key];
            if (sound) {
                // Rewind and Play
                sound.currentTime = 0;
                sound.play().catch(err => console.log("Audio Error:", err));
            }
        }

        // 3. The "Unlock" Function
        // Called on User Click to force browser to allow audio
        function unlockAudio() {
            if (isMuted) return;
            Object.values(audioLib).forEach(sound => {
                // Play silent for a millisecond
                sound.volume = 0;
                sound.play().then(() => {
                    sound.pause();
                    sound.currentTime = 0;
                    sound.volume = 1; // Restore volume
                }).catch(e => {});
            });
        }
        // -----------------------------

        const setupArea = document.getElementById('setup-area');
        const workoutArea = document.getElementById('workout-area');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const statusLabel = document.getElementById('status-label');
        const timeDisplay = document.getElementById('time-remaining');
        const currRoundDisp = document.getElementById('curr-round');
        const totalRoundsDisp = document.getElementById('total-rounds-disp');
        const delayCheck = document.getElementById('delay-in');
        
        const tabataBtn = document.getElementById('tabata-btn');
        const sfxBtn = document.getElementById('sfx-btn');

        function formatTime(seconds) { return seconds < 10 ? `0${seconds}` : seconds; }
        function updateDisplay() { timeDisplay.textContent = formatTime(timeLeft); }

        function switchMode() {
            // Case 1: End of Initial Delay
            if (isDelaying) {
                isDelaying = false;
                statusLabel.classList.remove('blinking');
                startActualWorkRound();
                return;
            }

            // Case 2: We were resting, time to Work
            if (!isWorking) {
                currentRound++; 
                currRoundDisp.textContent = currentRound;
                isWorking = true;
                startActualWorkRound(); 
                return;
            }

            // Case 3: We were working
            if (isWorking) {
                // Check if LAST round
                if (currentRound >= totalRounds) {
                    endGame();
                    return;
                }

                // Go to rest
                isWorking = false;
                timeLeft = restSecs;
                setStatus("REST...", "#ffff00");
                playSfx('rest');
                updateDisplay();
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            statusLabel.textContent = "DONE!";
            statusLabel.style.color = "var(--crt-green)";
            timeDisplay.textContent = "END";
            playSfx('victory');
        }

        function setStatus(text, color) {
            statusLabel.textContent = text;
            statusLabel.style.color = color;
        }

        function startActualWorkRound() {
            isWorking = true;
            
            // Check Final Round
            if(currentRound === totalRounds) {
                 playSfx('final');
                 setStatus("FINAL!", "#ff3333");
            } else {
                 playSfx('work');
                 setStatus("WORK!", "var(--crt-green)");
            }
            timeLeft = workSecs;
            updateDisplay();
        }

        function tick() {
            // 1. Decrement Time
            timeLeft--;
            
            // 2. Update Display
            updateDisplay();

            // 3. Beep Logic (At 3, 2, 1)
            // Note: Since we use global objects now, "3" will get cut off by "2"
            // This is actually GOOD for mobile performance and syncing.
            if (timeLeft === 3 || timeLeft === 2 || timeLeft === 1) {
                playSfx('beep');
            }

            // 4. Check End
            if (timeLeft <= 0) {
                switchMode();
            }
        }

        function startWorkout() {
            // UNLOCK AUDIO NOW
            unlockAudio();

            workSecs = parseInt(document.getElementById('work-in').value);
            restSecs = parseInt(document.getElementById('rest-in').value);
            totalRounds = parseInt(document.getElementById('rounds-in').value);
            
            if(workSecs < 1 || restSecs < 1 || totalRounds < 1) return;

            currentRound = 1;
            totalRoundsDisp.textContent = totalRounds;
            currRoundDisp.textContent = currentRound;
            
            setupArea.classList.add('hidden');
            workoutArea.classList.remove('hidden');

            if (delayCheck.checked) {
                isDelaying = true;
                timeLeft = 5;
                setStatus("PREP", "orange");
                statusLabel.classList.add('blinking');
            } else {
                isDelaying = false;
                startActualWorkRound();
            }
            updateDisplay();
            timerInterval = setInterval(tick, 1000);
        }

        function resetWorkout() {
            clearInterval(timerInterval);
            statusLabel.classList.remove('blinking');
            workoutArea.classList.add('hidden');
            setupArea.classList.remove('hidden');
        }

        // --- LISTENERS ---
        tabataBtn.addEventListener('click', () => {
            document.getElementById('work-in').value = 20;
            document.getElementById('rest-in').value = 10;
            document.getElementById('rounds-in').value = 8;
        });

        sfxBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            sfxBtn.classList.toggle('sfx-muted');
        });

        startBtn.addEventListener('click', startWorkout);
        resetBtn.addEventListener('click', resetWorkout);
    </script>
</body>
</html>

